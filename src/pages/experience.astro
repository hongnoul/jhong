---
import BaseLayout from "../layouts/BaseLayout.astro";
import fs from "node:fs";
import path from "node:path";

const portfolioDir = new URL("../../public/portfolio", import.meta.url);
const portfolioFiles = fs
	.readdirSync(portfolioDir, { withFileTypes: true })
	.filter((entry) => entry.isFile())
	.map((entry) => entry.name)
	.filter((name) => [".jpg", ".jpeg", ".png", ".webp"].includes(path.extname(name).toLowerCase()))
	.sort((a, b) => a.localeCompare(b, "en", { numeric: true }));
---

<BaseLayout>
	<main class="mx-auto flex max-w-4xl flex-col gap-8">

		<section class="overflow-visible">
			<table class="experience-table w-full table-auto border-separate border-spacing-0">
				<thead>
					<tr class="text-[0.7rem] font-semibold uppercase tracking-[0.25em] text-white">
						<th class="experience-sticky-cell hidden px-4 py-3 text-left md:table-cell">Year</th>
						<th class="experience-sticky-cell px-4 py-3 text-left">Client/Subject</th>
						<th class="experience-sticky-cell hidden px-4 py-3 text-left md:table-cell">Location</th>
						<th class="experience-sticky-cell px-4 py-3 text-left">Scope</th>
					</tr>
				</thead>
				<tbody class="text-xl text-white">
					<tr
						class="group border-t border-neutral-200 transition-colors duration-200 hover:cursor-pointer hover:bg-white hover:text-black"
						data-preview="trustai"
						data-has-link="true"
						data-link="https://trustai-astro.vercel.app/"
					>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">2025</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">TrustAI</span></td>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">San Francisco, CA</span></td>
						<td class="px-4 pb-24 pt-6">
							<span class="cell-clamp">Product Management, <br>Logo & Website Design</span>
						</td>
					</tr>
					<tr
						class="group border-t border-neutral-200 transition-colors duration-200 hover:cursor-pointer hover:bg-white hover:text-black"
						data-preview="roka"
					>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">2024</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">Republic of Korea Army</span></td>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell">
							<span class="cell-clamp">Yeoncheon, KR</span>
						</td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">Call of Duty</span></td>
					</tr>
					<tr
						class="group border-t border-neutral-200 transition-colors duration-200 hover:cursor-pointer hover:bg-white hover:text-black"
						data-preview="mit"
					>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">2024</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">History at MIT</span></td>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">Cambridge, MA</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">Web Exhibit</span></td>
					</tr>
					<tr
						class="group border-t border-neutral-200 transition-colors duration-200 hover:cursor-pointer hover:bg-white hover:text-black"
						data-preview="doraji"
						data-has-link="true"
						data-link="https://bandoraji.bandcamp.com/"
					>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">2024</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">Doraji</span></td>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell">
							<span class="cell-clamp">Seoul, KR</span>
						</td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">Music Production</span></td>
					</tr>
					<tr
						class="group border-t border-neutral-200 transition-colors duration-200 hover:cursor-pointer hover:bg-white hover:text-black"
						data-expand="portfolio"
						data-preview="portfolio"
						aria-expanded="false"
					>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">2022</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">AP Studio Art: 3D</span></td>
						<td class="hidden px-4 pb-24 pt-6 md:table-cell"><span class="cell-clamp">Seoul, KR</span></td>
						<td class="px-4 pb-24 pt-6"><span class="cell-clamp">Portfolio</span></td>
					</tr>
					<tr class="hidden border-t border-neutral-200" data-expand-content="portfolio">
						<td colSpan="4" class="px-4 pb-10 pt-2">
							<div class="grid gap-4 sm:grid-cols-2 md:grid-cols-3">
								{portfolioFiles.map((file) => (
									<img
										src={`/portfolio/${file}`}
										alt={`AP Studio Art ${file}`}
										class="h-48 w-full cursor-zoom-in object-cover"
										loading="lazy"
										data-portfolio-image
									/>
								))}
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</section>
	</main>
</BaseLayout>

<img
	id="trustai-preview"
	src="/TrustAI.svg"
	alt="TrustAI"
	class="pointer-events-none fixed left-0 top-0 z-50 hidden w-[480px] -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-150"
/>
<img
	id="roka-preview"
	src="/roka.png"
	alt="Republic of Korea Army"
	class="pointer-events-none fixed left-0 top-0 z-50 hidden w-[720px] -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-150"
/>
<img
	id="mit-preview"
	src="/mural.webp"
	alt="History at MIT"
	class="pointer-events-none fixed left-0 top-0 z-50 hidden w-[360px] -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-150"
/>
<img
	id="doraji-preview"
	src="/doraji.webp"
	alt="Doraji"
	class="pointer-events-none fixed left-0 top-0 z-50 hidden w-[240px] -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-150"
/>
<img
	id="portfolio-preview"
	src="/portfolio.webp"
	alt="AP Studio Art Portfolio"
	class="pointer-events-none fixed left-0 top-0 z-50 hidden w-[360px] -translate-x-1/2 -translate-y-1/2 opacity-0 transition-opacity duration-150"
/>

<script is:inline data-astro-rerun>
	const initPreviews = () => {
		if (window.matchMedia("(max-width: 768px)").matches) {
			return;
		}
		const attachPreview = ({ previewId, rowSelector, onClick }) => {
			const preview = document.querySelector(previewId);
			const row = document.querySelector(rowSelector);
			if (!preview || !row || row.dataset.previewBound === "true") {
				return;
			}
			row.dataset.previewBound = "true";

			const show = () => {
				preview.classList.remove("hidden");
				requestAnimationFrame(() => {
					preview.classList.remove("opacity-0");
					preview.classList.add("opacity-100");
				});
			};
			const hide = () => {
				preview.classList.remove("opacity-100");
				preview.classList.add("opacity-0");
				setTimeout(() => {
					preview.classList.add("hidden");
				}, 150);
			};
			const move = (event) => {
				const offset = 24;
				preview.style.left = `${event.clientX + offset}px`;
				preview.style.top = `${event.clientY + offset}px`;
			};

			row.addEventListener("mouseenter", show);
			row.addEventListener("mouseleave", hide);
			row.addEventListener("mousemove", move);
			if (onClick) {
				row.addEventListener("click", onClick);
			}
		};

		attachPreview({
			previewId: "#trustai-preview",
			rowSelector: '[data-preview="trustai"]',
			onClick: (event) => {
				const url = event.currentTarget?.dataset?.link;
				if (url) {
					window.open(url, "_blank", "noopener");
				}
			},
		});

		attachPreview({
			previewId: "#roka-preview",
			rowSelector: '[data-preview="roka"]',
		});

		attachPreview({
			previewId: "#mit-preview",
			rowSelector: '[data-preview="mit"]',
		});

		attachPreview({
			previewId: "#doraji-preview",
			rowSelector: '[data-preview="doraji"]',
			onClick: (event) => {
				const url = event.currentTarget?.dataset?.link;
				if (url) {
					window.open(url, "_blank", "noopener");
				}
			},
		});

		attachPreview({
			previewId: "#portfolio-preview",
			rowSelector: '[data-preview="portfolio"]',
		});
	};

	document.addEventListener("astro:page-load", initPreviews);
	if (document.readyState !== "loading") {
		initPreviews();
	}

	const initPortfolioToggle = () => {
		const row = document.querySelector('[data-expand="portfolio"]');
		const contentRow = document.querySelector('[data-expand-content="portfolio"]');
		if (!row || !contentRow || row.dataset.expandBound === "true") {
			return;
		}
		row.dataset.expandBound = "true";

		row.addEventListener("click", () => {
			const isOpen = row.getAttribute("aria-expanded") === "true";
			row.setAttribute("aria-expanded", isOpen ? "false" : "true");
			contentRow.classList.toggle("hidden", isOpen);
		});
	};

	document.addEventListener("astro:page-load", initPortfolioToggle);
	if (document.readyState !== "loading") {
		initPortfolioToggle();
	}

	const getViewer = () => {
		const viewer = document.querySelector("[data-portfolio-viewer]");
		const viewerImg = viewer?.querySelector("img");
		if (!viewer || !viewerImg) {
			return null;
		}

		const open = (src, alt) => {
			viewerImg.src = src;
			viewerImg.alt = alt || "";
			viewer.classList.remove("hidden");
			requestAnimationFrame(() => {
				viewer.classList.remove("opacity-0");
				viewer.classList.add("opacity-100");
			});
		};

		const close = () => {
			viewer.classList.remove("opacity-100");
			viewer.classList.add("opacity-0");
			setTimeout(() => {
				viewer.classList.add("hidden");
				viewerImg.src = "";
				viewerImg.alt = "";
			}, 150);
		};

		return { viewer, viewerImg, open, close };
	};

	const initPortfolioViewer = () => {
		const viewerState = getViewer();
		if (!viewerState || viewerState.viewer.dataset.viewerBound === "true") {
			return;
		}
		const { viewer, open, close } = viewerState;
		viewer.dataset.viewerBound = "true";

		document.querySelectorAll("[data-portfolio-image]").forEach((img) => {
			if (img.dataset.viewerBound === "true") return;
			img.dataset.viewerBound = "true";
			img.addEventListener("click", () => {
				open(img.currentSrc || img.src, img.alt);
			});
		});

		viewer.addEventListener("click", (event) => {
			if (event.target === viewer) {
				close();
			}
		});
	};

	document.addEventListener("astro:page-load", initPortfolioViewer);
	if (document.readyState !== "loading") {
		initPortfolioViewer();
	}

	const initMobileRowPreview = () => {
		if (!window.matchMedia("(max-width: 768px)").matches) {
			return;
		}
		const viewerState = getViewer();
		if (!viewerState) {
			return;
		}
		const { open } = viewerState;
			document
				.querySelectorAll(
					'[data-preview]:not([data-has-link]):not([data-expand])'
				)
				.forEach((row) => {
					if (row.dataset.mobilePreviewBound === "true") return;
					row.dataset.mobilePreviewBound = "true";
					row.addEventListener("click", () => {
						const key = row.dataset.preview;
						const preview = key
							? document.querySelector(`#${key}-preview`)
							: null;
						if (!preview) return;
						open(preview.src, preview.alt);
					});
				});
			document.querySelectorAll("[data-has-link][data-link]").forEach((row) => {
				if (row.dataset.mobileLinkBound === "true") return;
				row.dataset.mobileLinkBound = "true";
				row.addEventListener("click", () => {
					window.open(row.dataset.link, "_blank", "noopener");
				});
			});
	};

	document.addEventListener("astro:page-load", initMobileRowPreview);
	if (document.readyState !== "loading") {
		initMobileRowPreview();
	}
</script>

<div
	class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 opacity-0 transition-opacity duration-150"
	data-portfolio-viewer
>
	<img class="max-h-[90vh] max-w-[90vw] object-contain" alt="" />
</div>
