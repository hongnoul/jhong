---
type Props = {
    id?: string;
    speed?: number;
    debug?: boolean;
};

const {
    id = "site-marquee",
    speed = 80,
    debug = false,
} = Astro.props as Props;
---

<div
    id={id}
    class="fixed left-0 right-0 top-0 z-[11] flex h-[var(--marquee-height)] overflow-hidden bg-transparent text-black"
    data-marquee-root
    data-speed={speed}
    data-debug={debug ? "true" : "false"}
    transition:persist
>
    <div
        class="flex min-w-full flex-none items-center gap-10 whitespace-nowrap pl-10 font-[galmuri9] text-[1.1rem] lowercase tracking-[0.18em] will-change-transform"
        data-marquee-track
        transition:persist
    >
        <slot>
            <span>Seoul, KR</span>
            <span>namyang@mit.edu</span>
            <span>U.S. Citizen</span>
            <span>namyang@mit.edu</span>
            <span>Boston, MA</span>
            <span>namyang@mit.edu</span>
            <span>$jhong.sol</span>
            <span>namyang@mit.edu</span>
            <span>Seoul, KR</span>
            <span>namyang@mit.edu</span>
            <span>U.S. Citizen</span>
            <span>namyang@mit.edu</span>
            <span>Boston, MA</span>
            <span>namyang@mit.edu</span>
            <span>$jhong.sol</span>
            <span>namyang@mit.edu</span>
        </slot>
    </div>
</div>

<script type="module">
    const roots = document.querySelectorAll("[data-marquee-root]");
    roots.forEach((root) => {
        const track = root.querySelector("[data-marquee-track]");
        if (!track) return;

        const debug = root.dataset.debug === "true";
        if (debug && typeof track.animate === "function") {
            track.animate(
                [
                    { transform: "translateX(0px)" },
                    { transform: "translateX(-60px)" },
                ],
                { duration: 900, iterations: Infinity, direction: "alternate" }
            );
            return;
        }

        if (track.dataset.cloned !== "true") {
            track.dataset.cloned = "true";
            track.innerHTML += track.innerHTML;
        }

        const KEY = `__marquee_state__:${root.id}`;
        const SPEED = Number(root.dataset.speed) || 80;
        const stateStore = (window.__MARQUEE_STATE__ ||= {});
        const saved = stateStore[KEY];

        let controls = null;
        let distance = 0;

        const startMotion = async () => {
            let animateFn = null;
            try {
                const mod = await import("@motionone/dom");
                animateFn = mod.animate;
            } catch (err) {
                console.error("MotionMarquee: failed to load @motionone/dom", err);
                return;
            }

            const start = () => {
                if (controls) controls.cancel?.();

                measure();

                if (distance <= 0) return;

                const duration = distance / SPEED;

                controls = animateFn(
                    track,
                    [
                        { transform: "translateX(0px)" },
                        { transform: `translateX(${-distance}px)` },
                    ],
                    {
                        duration,
                        easing: "linear",
                        iterations: Infinity,
                    }
                );

                if (saved && typeof saved.currentTime === "number") {
                    try {
                        controls.currentTime = saved.currentTime % duration;
                    } catch {}
                }
            };

            const save = () => {
                if (!controls) return;
                stateStore[KEY] = {
                    currentTime: controls.currentTime ?? 0,
                    at: Date.now(),
                };
            };

            document.addEventListener("astro:before-swap", save);
            document.addEventListener("astro:after-swap", start);

            let resizeTimer = null;
            window.addEventListener("resize", () => {
                if (resizeTimer) clearTimeout(resizeTimer);
                const t = controls?.currentTime ?? 0;
                resizeTimer = setTimeout(() => {
                    stateStore[KEY] = { currentTime: t, at: Date.now() };
                    start();
                }, 100);
            });

            start();
        };

        const measure = () => {
            const trackWidth = track.scrollWidth;
            distance = Math.max(0, trackWidth / 2);
            if (!Number.isFinite(distance)) distance = 0;
        };

        startMotion();
    });
</script>
  
